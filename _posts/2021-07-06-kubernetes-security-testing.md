---
layout: post
title: Kubernetes Security Testing Mindmap
date: 2021-07-06 00:00:00 +0100
description: A mindmap to guide Kubernetes security testing
tags: [Kubernetes, Pentest] # add tag
toc: false
comments: false
---

# Kubernetes Security Testing Mindmap
Over the past months I've been looking at different Kubernetes clusters from different vendors and this mindmap helped me stay organized on what to look for when it comes to security testing.

In the mindmap there's a section dedicated to AWS and EKS including best practices, plus a Kubernetes section and an Istio section. Treat this mindmap as a checklist of stuff to hunt in the cluster.


<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.1.5/dist/style.min.css">
</head>
<div class="post-content">
<svg id="mindmap" style="width: 800px; height: 800px"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.6.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.2.3"></script><script>(getMarkmap => {
          window.WebFontConfig = {
            custom: {
              families: ['KaTeX_AMS', 'KaTeX_Caligraphic:n4,n7', 'KaTeX_Fraktur:n4,n7', 'KaTeX_Main:n4,n7,i4,i7', 'KaTeX_Math:i4,i7', 'KaTeX_Script', 'KaTeX_SansSerif:n4,n7,i4', 'KaTeX_Size1', 'KaTeX_Size2', 'KaTeX_Size3', 'KaTeX_Size4', 'KaTeX_Typewriter']
            },
            active: () => {
              getMarkmap().refreshHook.call();
            }
          };
        })(() => window.markmap)</script><script src="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.js" defer></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.1.5/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, data) => {
        const {
          Markmap
        } = getMarkmap();
        window.mm = Markmap.create('svg#mindmap', getOptions == null ? void 0 : getOptions(), data);
      })(() => window.markmap,null,{"t":"heading","d":1,"p":{"lines":[0,1]},"v":"Kubernetes Security","c":[{"t":"heading","d":2,"p":{"lines":[2,3]},"v":"AWS","c":[{"t":"list_item","d":4,"p":{"lines":[4,5]},"v":"<a href=\"https://github.com/toniblyx/prowler#features\">Prowler</a>"},{"t":"list_item","d":4,"p":{"lines":[6,7]},"v":"<a href=\"https://github.com/dagrz/aws_pwn\">aws_pwn</a>"},{"t":"list_item","d":4,"p":{"lines":[8,9]},"v":"<a href=\"https://github.com/cyberark/SkyArk\">SkyArk</a> powershell module"},{"t":"list_item","d":4,"p":{"lines":[10,11]},"v":"EKS","c":[{"t":"list_item","d":6,"p":{"lines":[11,12]},"v":"<a href=\"https://docs.aws.amazon.com/eks/latest/userguide/security.html\">Official docs</a>"},{"t":"list_item","d":6,"p":{"lines":[12,13]},"v":"<a href=\"https://aws.github.io/aws-eks-best-practices/\">EKS Best Practices</a>","c":[{"t":"list_item","d":8,"p":{"lines":[13,14]},"v":"Don't use a service account token for authentication (A service account token is a long-lived, static credential. If it is compromised, lost, or stolen, an attacker may be able to perform all the actions associated with that token until the service account is deleted)"},{"t":"list_item","d":8,"p":{"lines":[14,15]},"v":"Least privileged access to AWS resources"},{"t":"list_item","d":8,"p":{"lines":[15,16]},"v":"Dedicated IAM role for cluster creation (When you create an Amazon EKS cluster, the IAM entity user or role is automatically granted system:masters permissions in the cluster's RBAC configuration. )"},{"t":"list_item","d":8,"p":{"lines":[16,17]},"v":"Make the EKS Cluster Endpoint private (or public with CIDR blocks whitelisting )"},{"t":"list_item","d":8,"p":{"lines":[17,18]},"v":"Audit logs (https://docs.aws.amazon.com/eks/latest/userguide/control-plane-logs.html#enabling-control-plane-log-export)"},{"t":"list_item","d":8,"p":{"lines":[18,19]},"v":"Create alarms for suspicious events (use attributes like host, sourceIPs, and k8s_user.username)"},{"t":"list_item","d":8,"p":{"lines":[19,20]},"v":"Audit your CloudTrail logs (AWS APIs called by pods that are utilising IAM Roles for Service Accounts (IRSA) are automatically logged to CloudTrail along with the name of the service account.)"},{"t":"list_item","d":8,"p":{"lines":[20,21]},"v":"Check /var/run/secrets/kubernetes.io/serviceaccount for sa and their permissions"},{"t":"list_item","d":8,"p":{"lines":[21,22]},"v":"Tenant isolation"},{"t":"list_item","d":8,"p":{"lines":[22,23]},"v":"Pod capabilities"},{"t":"list_item","d":8,"p":{"lines":[23,24]},"v":"Use dedicated service accounts for each application (This applies to service accounts for the Kubernetes API as well as IRSA.)"},{"t":"list_item","d":8,"p":{"lines":[24,25]},"v":"Scope the binding for privileged pods to service accounts within a particular namespace, e.g. kube-system, and limiting access to that namespace."},{"t":"list_item","d":8,"p":{"lines":[25,26]},"v":"Do not run processes in containers as root ( The Kubernetes podSpec includes a set of fields under spec.securityContext, that allow to let you specify the user and/or group to run your application as)"},{"t":"list_item","d":8,"p":{"lines":[26,27]},"v":"Run the application as a non-root user (Containers run as root by default, consider adding the spec.securityContext.runAsUser attribute to the PodSpec)"},{"t":"list_item","d":8,"p":{"lines":[27,28]},"v":"Grant least privileged access to applications"},{"t":"list_item","d":8,"p":{"lines":[28,29]},"v":"Never run Docker in Docker or mount the socket in the container"},{"t":"list_item","d":8,"p":{"lines":[29,30]},"v":"Restrict the use of hostPath or if hostPath is necessary restrict which prefixes can be used and configure the volume as read-only (By default pods that run as root will have write access to the file system exposed by hostPath, to mitigate the risks from hostPath, configure the spec.containers.volumeMounts as readOnly AND use a pod security policy to restrict the directories that can be used by hostPath volumes, see https://labs.bishopfox.com/tech-blog/bad-pods-kubernetes-pod-privilege-escalation)"},{"t":"list_item","d":8,"p":{"lines":[30,31]},"v":"Set requests and limits for each container to avoid resource contention and DoS attacks (The podSpec allows you to specify requests and limits for CPU and memory)"},{"t":"list_item","d":8,"p":{"lines":[31,32]},"v":"Do not allow privileged escalation (You can prevent a container from using privileged escalation by implementing a pod security policy that sets allowPriviledgedEscalation to false or by setting securityContext.allowPrivilegedEscalation in the podSpec.)"},{"t":"list_item","d":8,"p":{"lines":[32,33]},"v":"Update the aws-node daemonset to use IRSA  (default: the aws-node daemonset is configured to use a role assigned to the EC2 instances to assign IPs to pods)"},{"t":"list_item","d":8,"p":{"lines":[33,34]},"v":"Restrict access to the instance profile assigned to the worker node (the pod can still inherit the rights of the instance profile assigned to the worker node)"},{"t":"list_item","d":8,"p":{"lines":[34,35]},"v":"Scope the IAM Role trust policy for IRSA to the service account name (it's best to make the role trust policy as explicit as possible by including the service account name. This will effectively prevent other Pods within the same Namespace from assuming the role.)"},{"t":"list_item","d":8,"p":{"lines":[35,36]},"v":"Disable auto-mounting of service account tokens (If your application doesn't need to call the Kubernetes API set the automountServiceAccountToken attribute to false in the PodSpec: kubectl patch serviceaccount default -p $'automountServiceAccountToken: false')"},{"t":"list_item","d":8,"p":{"lines":[36,37]},"v":"Tenant isolation (soft = namespaces or role bindings; Hard = separate clusters )"},{"t":"list_item","d":8,"p":{"lines":[37,38]},"v":"Create a default deny policy (network)"},{"t":"list_item","d":8,"p":{"lines":[38,39]},"v":"Create a rule to allow DNS queries"},{"t":"list_item","d":8,"p":{"lines":[39,40]},"v":"Log network traffic metadata (Manuela note: good recommendation but this could get very expensive really quick)"},{"t":"list_item","d":8,"p":{"lines":[40,41]},"v":"Use encryption with AWS load balancers ( alb.ingress.kubernetes.io/certificate-arn --&gt; adds certificates)"},{"t":"list_item","d":8,"p":{"lines":[41,42]},"v":"Security group setup (https://docs.aws.amazon.com/eks/latest/userguide/sec-group-reqs.html)"},{"t":"list_item","d":8,"p":{"lines":[42,43]},"v":"Encryption in transit (for HIPAA PCI), use TCL, Service Mesh, Ingress Controllers and Load Balancers"},{"t":"list_item","d":8,"p":{"lines":[43,44]},"v":"Encrypt data at rest"},{"t":"list_item","d":8,"p":{"lines":[44,45]},"v":"Rotate your CMKs periodically (Configure KMS to automatically rotate you CMKs)"},{"t":"list_item","d":8,"p":{"lines":[45,46]},"v":"Use AWS KMS for envelope encryption of Kubernetes secrets."},{"t":"list_item","d":8,"p":{"lines":[46,47]},"v":"Audit secrets: use Kubernetes audit log: {(<span class=\"katex-error\" title=\"ParseError: KaTeX parse error: Expected &#x27;EOF&#x27;, got &#x27;&amp;&#x27; at position 14: .verb=&quot;get&quot;) &amp;Ì²&amp; (\" style=\"color:#cc0000\">.verb=&quot;get&quot;) &amp;&amp; (</span>.objectRef.resource=&quot;secret&quot;)}"},{"t":"list_item","d":8,"p":{"lines":[47,48]},"v":"Rotate secrets periodically (Kubernetes doesn't automatically rotate secrets)"},{"t":"list_item","d":8,"p":{"lines":[48,49]},"v":"Use separate namespaces as a way to isolate secrets from different applications"},{"t":"list_item","d":8,"p":{"lines":[49,50]},"v":"Use volume mounts instead of environment variables (The values of environment variables can unintentionally appear in logs)"},{"t":"list_item","d":8,"p":{"lines":[50,51]},"v":"Use an external secrets provider (e.g. Hashicorp's Vault)"},{"t":"list_item","d":8,"p":{"lines":[51,52]},"v":"Runtime security (drop linux capabilities / use Pod Security Policies / AppArmor)"},{"t":"list_item","d":8,"p":{"lines":[52,53]},"v":"Minimize access to worker nodes (Instead of enabling SSH access, use SSM Session Manager when you need to remote into a host. https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html)"},{"t":"list_item","d":8,"p":{"lines":[53,54]},"v":"Deploy workers onto private subnets"},{"t":"list_item","d":8,"p":{"lines":[54,55]},"v":"Run Amazon Inspector to assess hosts for exposure, vulnerabilities, and deviations from best practices (Inspector requires the deployment of an agent)"},{"t":"list_item","d":8,"p":{"lines":[55,56]},"v":"Configure Selinux (https://github.com/containers/container-selinux)"},{"t":"list_item","d":8,"p":{"lines":[56,57]},"v":"Create minimal images (Start by removing all extraneous binaries from the container image)"},{"t":"list_item","d":8,"p":{"lines":[57,58]},"v":"Scan images for vulnerabilities regularly"},{"t":"list_item","d":8,"p":{"lines":[58,59]},"v":"Create IAM policies for ECR repositories (If different teams don't need to share assets, you may want to create a set of IAM policies that restrict access to the repositories each team can interact with.)"},{"t":"list_item","d":8,"p":{"lines":[59,60]},"v":"Consider using ECR private endpoints (The ECR API has a public endpoint)"},{"t":"list_item","d":8,"p":{"lines":[60,61]},"v":"Implement endpoint policies for ECR ( The default endpoint policy for allows access to all ECR repositories within a region)"},{"t":"list_item","d":8,"p":{"lines":[61,62]},"v":"Create a set of curated images (consider creating a set of vetted images for the different application stacks in your organization)"},{"t":"list_item","d":8,"p":{"lines":[62,63]},"v":"Lint your Dockerfiles"},{"t":"list_item","d":8,"p":{"lines":[63,64]},"v":"Build and sign your images"}]},{"t":"list_item","d":6,"p":{"lines":[64,65]},"v":"<a href=\"https://github.com/RhinoSecurityLabs/ccat\">ccat</a>"}]}]},{"t":"heading","d":2,"p":{"lines":[67,68]},"v":"K8S","c":[{"t":"heading","d":3,"p":{"lines":[69,70]},"v":"<a href=\"https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-1\">Kubernetes pentest methodology</a>","c":[{"t":"heading","d":4,"p":{"lines":[70,71]},"v":"RBAC configuration","c":[{"t":"list_item","d":6,"p":{"lines":[71,72]},"v":"https://github.com/appvia/krane"},{"t":"list_item","d":6,"p":{"lines":[72,73]},"v":"<a href=\"https://github.com/cyberark/kubernetes-rbac-audit\">k8s-rbac-audit</a>","c":[{"t":"list_item","d":8,"p":{"lines":[73,74]},"v":"Listing secrets"},{"t":"list_item","d":8,"p":{"lines":[74,75]},"v":"Access any resource <code>resources: [&quot;*&quot;] verbs[&quot;create&quot;|&quot;list&quot;|&quot;get&quot;]</code>"},{"t":"list_item","d":8,"p":{"lines":[75,76]},"v":"Pod creation"}]},{"t":"list_item","d":6,"p":{"lines":[77,78]},"v":"Privesc","c":[{"t":"list_item","d":8,"p":{"lines":[78,79]},"v":"Creating pods in <code>kube-system</code> is a no no"},{"t":"list_item","d":8,"p":{"lines":[79,80]},"v":"<code>bootstrap-signer</code> service account"},{"t":"list_item","d":8,"p":{"lines":[80,81]},"v":"<code>kubectl node-shell &lt;node&gt;</code> <a href=\"https://github.com/kvaps/kubectl-node-shell\">more info</a>"},{"t":"list_item","d":8,"p":{"lines":[81,82]},"v":"Change role-bindings","c":[{"t":"list_item","d":10,"p":{"lines":[82,83]},"v":"<code>curl -k -v -X POST -H âAuthorization: Bearer &lt;JWT TOKEN&gt;â -H âContent-Type: application/jsonâ https://&lt;master_ip&gt;:&lt;port&gt;/apis/rbac.authorization.k8s.io/v1/namespaces/default/rolebindings -d @malicious-RoleBinging.json</code>"}]},{"t":"list_item","d":8,"p":{"lines":[83,84]},"v":"Impersonate","c":[{"t":"list_item","d":10,"p":{"lines":[84,85]},"v":"<code>edit</code>, <code>admin</code> and  clusterroles has impersonate"},{"t":"list_item","d":10,"p":{"lines":[85,86]},"v":"<code>curl -k -v -XGET -H âAuthorization: Bearer &lt;JWT TOKEN (of the impersonator)&gt;â -H âImpersonate-Group: system:mastersâ -H âImpersonate-User: nullâ -H âAccept: application/jsonâ https://&lt;master_ip&gt;:&lt;port&gt;/api/v1/namespaces/kube-system/secrets/</code>"}]}]}]},{"t":"heading","d":4,"p":{"lines":[87,88]},"v":"Endpoints","c":[{"t":"list_item","d":6,"p":{"lines":[88,89]},"v":"Port Scanning","c":[{"t":"list_item","d":8,"p":{"lines":[89,90]},"v":"443 - kube-apiserver"},{"t":"list_item","d":8,"p":{"lines":[90,91]},"v":"2379 - etcd"},{"t":"list_item","d":8,"p":{"lines":[91,92]},"v":"4194 - cAdvisor"},{"t":"list_item","d":8,"p":{"lines":[92,93]},"v":"6443 - kube-apiserver"},{"t":"list_item","d":8,"p":{"lines":[93,94]},"v":"8443 - Minikube kube-apiserver"},{"t":"list_item","d":8,"p":{"lines":[94,95]},"v":"8080 - insecure kube-apiserver"},{"t":"list_item","d":8,"p":{"lines":[95,96]},"v":"10250, 10255 - kubelet"},{"t":"list_item","d":8,"p":{"lines":[96,97]},"v":"10256 - kube-proxy"},{"t":"list_item","d":8,"p":{"lines":[97,98]},"v":"9099 - calico-felix"},{"t":"list_item","d":8,"p":{"lines":[98,99]},"v":"6782-4 - weave (metric and endpoints)"}]},{"t":"list_item","d":6,"p":{"lines":[100,101]},"v":"Anonymous API access","c":[{"t":"list_item","d":8,"p":{"lines":[101,102]},"v":"/api"},{"t":"list_item","d":8,"p":{"lines":[102,103]},"v":"/apis"},{"t":"list_item","d":8,"p":{"lines":[103,104]},"v":"/apis/apps"},{"t":"list_item","d":8,"p":{"lines":[104,105]},"v":"/apis/authorization.k8s.io"},{"t":"list_item","d":8,"p":{"lines":[105,106]},"v":"<code>curl -k https://&lt;IP Address&gt;:(8|6)443/swaggerapi</code>"},{"t":"list_item","d":8,"p":{"lines":[106,107]},"v":"<code>curl -k https://&lt;IP Address&gt;:(8|6)443/healthz</code> or - <code>curl -k https://&lt;IP Address&gt;:(8|6)443/readyz</code>"},{"t":"list_item","d":8,"p":{"lines":[107,108]},"v":"<code>curl -k https://&lt;IP Address&gt;:(8|6)443/api/v1</code>"}]},{"t":"list_item","d":6,"p":{"lines":[109,110]},"v":"Anonymous ETCD access","c":[{"t":"list_item","d":8,"p":{"lines":[110,111]},"v":"Not exposed on EKS"},{"t":"list_item","d":8,"p":{"lines":[111,112]},"v":"<code>etcdctl âendpoints=http://&lt;MASTER-IP&gt;:2379 get / âprefix âkeys-only</code>"},{"t":"list_item","d":8,"p":{"lines":[112,113]},"v":"<code>curl -k https://&lt;IP address&gt;:2379</code>"},{"t":"list_item","d":8,"p":{"lines":[113,114]},"v":"<code>curl -k https://&lt;IP address&gt;:2379/version</code>"}]},{"t":"list_item","d":6,"p":{"lines":[115,116]},"v":"Anonymous Kubelet access","c":[{"t":"list_item","d":8,"p":{"lines":[116,117]},"v":"<code>curl -k http://&lt;external-IP&gt;:10255/pods</code>"},{"t":"list_item","d":8,"p":{"lines":[117,118]},"v":"<code>curl -k http://&lt;external-IP&gt;:10255/metrics</code>"},{"t":"list_item","d":8,"p":{"lines":[118,119]},"v":"<code>curl -k http://&lt;external-IP&gt;:10255/</code>"}]}]},{"t":"heading","d":4,"p":{"lines":[120,121]},"v":"Container Security","c":[{"t":"list_item","d":6,"p":{"lines":[121,122]},"v":"<code>cat /run/secrets/kubernetes.io/serviceaccount/token</code>","c":[{"t":"list_item","d":8,"p":{"lines":[122,123]},"v":"List pods","c":[{"t":"list_item","d":10,"p":{"lines":[123,124]},"v":"<code>curl -v -H âAuthorization: Bearer &lt;jwt_token&gt;â https://&lt;master_ip&gt;:&lt;port&gt;/api/v1/namespaces/default/pods/</code>"}]},{"t":"list_item","d":8,"p":{"lines":[124,125]},"v":"List secrets","c":[{"t":"list_item","d":10,"p":{"lines":[125,126]},"v":"<code>curl -v -H âAuthorization: Bearer &lt;jwt_token&gt;â https://&lt;master_ip&gt;:&lt;port&gt;/api/v1/namespaces/default/secrets/</code>"}]},{"t":"list_item","d":8,"p":{"lines":[126,127]},"v":"List deployments","c":[{"t":"list_item","d":10,"p":{"lines":[127,128]},"v":"<code>curl -v -H âAuthorization: Bearer &lt;jwt_token&gt;â https://&lt;master_ip:&lt;port&gt;/apis/extensions/v1beta1/namespaces/default/deployments</code>"}]},{"t":"list_item","d":8,"p":{"lines":[128,129]},"v":"List daemonsets","c":[{"t":"list_item","d":10,"p":{"lines":[129,130]},"v":"<code>curl -v -H âAuthorization: Bearer &lt;jwt_token&gt;â https://&lt;master_ip:&lt;port&gt;/apis/extensions/v1beta1/namespaces/default/daemonsets</code>"}]}]},{"t":"list_item","d":6,"p":{"lines":[131,132]},"v":"Kernel exploits"},{"t":"list_item","d":6,"p":{"lines":[133,134]},"v":"Least Privilege","c":[{"t":"list_item","d":8,"p":{"lines":[134,135]},"v":"containers should not run as root"}]},{"t":"list_item","d":6,"p":{"lines":[136,137]},"v":"Linux capabilities","c":[{"t":"list_item","d":8,"p":{"lines":[137,138]},"v":"<a href=\"https://linux-audit.com/linux-capabilities-101/\">linux capabilities 101</a>"},{"t":"list_item","d":8,"p":{"lines":[138,139]},"v":"cap_sys_admin"},{"t":"list_item","d":8,"p":{"lines":[139,140]},"v":"cap_sys_module"},{"t":"list_item","d":8,"p":{"lines":[140,141]},"v":"cap_sys_boot"},{"t":"list_item","d":8,"p":{"lines":[141,142]},"v":"<code>ps -aef</code>"},{"t":"list_item","d":8,"p":{"lines":[142,143]},"v":"<code>cat /proc/&lt;PID&gt;/status | grep -i cap</code>"},{"t":"list_item","d":8,"p":{"lines":[143,144]},"v":"(on your laptop) <code>capsh --decode=0000003fffffffff</code>"},{"t":"list_item","d":8,"p":{"lines":[144,145]},"v":"<a href=\"https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities\">default docker capabilities</a>"},{"t":"list_item","d":8,"p":{"lines":[145,146]},"v":"K8S Linux Capabilities can be added and dropped using the <a href=\"https://kubernetes.io/docs/tasks/configure-pod-container/security-context/\">securityContext</a>"}]},{"t":"list_item","d":6,"p":{"lines":[147,148]},"v":"Env and secrets in the container","c":[{"t":"list_item","d":8,"p":{"lines":[148,149]},"v":"<code>env</code>"},{"t":"list_item","d":8,"p":{"lines":[149,150]},"v":"secrets are in <code>/run/secrets/kubernetes.io/</code>"}]}]},{"t":"heading","d":4,"p":{"lines":[151,152]},"v":"Network Services","c":[{"t":"list_item","d":6,"p":{"lines":[152,153]},"v":"<code>kubectl get svc âall-namespaces</code>"},{"t":"list_item","d":6,"p":{"lines":[153,154]},"v":"Check for exposed AWS IAM key","c":[{"t":"list_item","d":8,"p":{"lines":[154,155]},"v":"<code>curl http://169.254.169.254/latest/meta-data/iam/security-credentials/</code>"},{"t":"list_item","d":8,"p":{"lines":[155,156]},"v":"<code>curl http://169.254.169.254/latest/meta-data/iam/security-credentials/&lt;IAM ROLE&gt;</code>"},{"t":"list_item","d":8,"p":{"lines":[156,157]},"v":"<a href=\"https://www.shellntel.com/blog/2019/8/27/aws-metadata-endpoint-how-to-not-get-pwned-like-capital-one\">CapitalOne breach</a>"},{"t":"list_item","d":8,"p":{"lines":[157,158]},"v":"Alternative endpoints","c":[{"t":"list_item","d":10,"p":{"lines":[158,159]},"v":"http://[::ffff:169.254.169.254]"},{"t":"list_item","d":10,"p":{"lines":[159,160]},"v":"http://[0:0:0:0:0:ffff:169.254.169.254]"},{"t":"list_item","d":10,"p":{"lines":[160,161]},"v":"http://425.510.425.510/ Dotted decimal with overflow"},{"t":"list_item","d":10,"p":{"lines":[161,162]},"v":"http://2852039166/ Dotless decimal"},{"t":"list_item","d":10,"p":{"lines":[162,163]},"v":"http://7147006462/ Dotless decimal with overflow"},{"t":"list_item","d":10,"p":{"lines":[163,164]},"v":"http://0xA9.0xFE.0xA9.0xFE/ Dotted hexadecimal"},{"t":"list_item","d":10,"p":{"lines":[164,165]},"v":"http://0xA9FEA9FE/ Dotless hexadecimal"},{"t":"list_item","d":10,"p":{"lines":[165,166]},"v":"http://0x41414141A9FEA9FE/ Dotless hexadecimal with overflow"},{"t":"list_item","d":10,"p":{"lines":[166,167]},"v":"http://0251.0376.0251.0376/ Dotted octal"},{"t":"list_item","d":10,"p":{"lines":[167,168]},"v":"http://0251.00376.000251.0000376/ Dotted octal with padding"},{"t":"list_item","d":10,"p":{"lines":[168,169]},"v":"http://169.254.169.254.xip.io/ DNS Name"},{"t":"list_item","d":10,"p":{"lines":[169,170]},"v":"http://A.8.8.8.8.1time.169.254.169.254.1time.repeat.rebind.network/ DNS Rebinding (8.8.8.8 -&gt; AWS Metadata)"}]}]}]}]},{"t":"heading","d":3,"p":{"lines":[171,172]},"v":"Kube hunter","c":[{"t":"list_item","d":5,"p":{"lines":[172,173]},"v":"<code>kubectl apply -f pentest/kubernetes/templates/kubehunter.yaml</code>"}]},{"t":"heading","d":3,"p":{"lines":[174,175]},"v":"<a href=\"https://github.com/cyberark/kubesploit\">Kube-sploit</a>"},{"t":"heading","d":3,"p":{"lines":[176,177]},"v":"Kubeaudit","c":[{"t":"list_item","d":5,"p":{"lines":[177,178]},"v":"Download from <a href=\"https://github.com/Shopify/kubeaudit/releases\">releases</a>"},{"t":"list_item","d":5,"p":{"lines":[178,179]},"v":"<code>tar -xf kubeaudit*</code>"},{"t":"list_item","d":5,"p":{"lines":[179,180]},"v":"<code>kubeaudit all</code>"}]}]},{"t":"heading","d":2,"p":{"lines":[182,183]},"v":"Istio","c":[{"t":"heading","d":3,"p":{"lines":[183,184]},"v":"Security Bulletins (<a href=\"https://istio.io/latest/news/security/\">https://istio.io/latest/news/security/</a>)"},{"t":"heading","d":3,"p":{"lines":[184,185]},"v":"Mutual TLS","c":[{"t":"heading","d":4,"p":{"lines":[185,186]},"v":"Is there an <code>allow-nothing</code> authorization policy on each namespace?","c":[{"t":"fence","d":5,"v":"<pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> security.istio.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> AuthorizationPolicy\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> allow<span class=\"token punctuation\">-</span>nothing\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> default\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"t":"heading","d":4,"p":{"lines":[195,196]},"v":"Is mTLS traffic on strict mode?","c":[{"t":"fence","d":5,"v":"<pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> security.istio.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PeerAuthentication\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"default\"</span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">mtls</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">mode</span><span class=\"token punctuation\">:</span> STRICT\n</code></pre>\n"}]},{"t":"heading","d":4,"p":{"lines":[205,206]},"v":"What authorization policies are configured? <code>kubectl get AuthorizationPolicy</code>"},{"t":"heading","d":4,"p":{"lines":[206,207]},"v":"What is the current path normalization configuration? <a href=\"https://istio.io/latest/docs/ops/best-practices/security/#customize-your-system-on-path-normalization\">https://istio.io/latest/docs/ops/best-practices/security/#customize-your-system-on-path-normalization</a>"}]},{"t":"heading","d":3,"p":{"lines":[209,210]},"v":"Gateways (<a href=\"https://istio.io/latest/docs/ops/best-practices/security/#gateways\">https://istio.io/latest/docs/ops/best-practices/security/#gateways</a>)","c":[{"t":"heading","d":4,"p":{"lines":[210,211]},"v":"Are there gateways configured?","c":[{"t":"list_item","d":6,"p":{"lines":[211,212]},"v":"Are there any overly broad <code>hosts</code> configurations?"},{"t":"list_item","d":6,"p":{"lines":[212,213]},"v":"Are critical services isolated?"}]},{"t":"heading","d":4,"p":{"lines":[213,214]},"v":"Restrict who can create Gateways"},{"t":"heading","d":4,"p":{"lines":[214,215]},"v":"Egress Gateway","c":[{"t":"list_item","d":6,"p":{"lines":[215,216]},"v":"Is it installed? <code>kubectl get pod -l istio=egressgateway -n istio-system</code>"},{"t":"list_item","d":6,"p":{"lines":[216,217]},"v":"What are the Virtual Services configured? <code>kubectl get VirtualService -A</code>","c":[{"t":"list_item","d":8,"p":{"lines":[217,218]},"v":"What are the service entries configured? <code>kubectl get ServiceEntry -A</code>"},{"t":"list_item","d":8,"p":{"lines":[218,219]},"v":"What are the Gateways configured and Destination rules? <code>kubectl get [Gateway, DestinationRule] -A</code>"}]},{"t":"list_item","d":6,"p":{"lines":[219,220]},"v":"https://istio.io/latest/docs/tasks/traffic-management/egress/egress-gateway/","c":[{"t":"list_item","d":8,"p":{"lines":[220,221]},"v":"Is there a firewall configured to only allow egress traffic coming from the Egress Gateway?"},{"t":"list_item","d":8,"p":{"lines":[221,222]},"v":"Is there a network policy configured preventing all egress traffic not coming from the Egress Gateway?","c":[{"t":"list_item","d":10,"p":{"lines":[222,223]},"v":"Interesting approach how to configure that: https://monzo.com/blog/controlling-outbound-traffic-from-kubernetes"},{"t":"list_item","d":10,"p":{"lines":[223,224]},"v":"An example network policy to enable DNS and enforce traffic through egress gateway:"}]},{"t":"list_item","d":8,"p":{"lines":[246,247]},"v":"Attackers who compromised a pod can bypass Envoy and all monitoring that's configured in the pod itself"}]}]}]},{"t":"heading","d":3,"p":{"lines":[248,249]},"v":"Ports used by Istio (<a href=\"https://istio.io/latest/docs/ops/deployment/requirements/#ports-used-by-istio\">https://istio.io/latest/docs/ops/deployment/requirements/#ports-used-by-istio</a>)","c":[{"t":"list_item","d":5,"p":{"lines":[249,250]},"v":"Lock down ports: <a href=\"https://istio.io/latest/docs/ops/best-practices/security/#lock-down-ports\">https://istio.io/latest/docs/ops/best-practices/security/#lock-down-ports</a>"}]}]}]})</script>
</div>
